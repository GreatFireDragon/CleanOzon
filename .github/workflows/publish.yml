name: Build, Release and Publish

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'

permissions:
  contents: write

jobs:
  build-release-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Читаем версию из ОБЩЕГО manifest.json
      - name: Read Version and Commit Message
        id: meta
        run: |
          # Теперь читаем из основного файла
          VERSION=$(jq -r '.version' manifest.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV
          
          echo "Detected version: $VERSION"
          echo "Commit message: $COMMIT_MSG"

      # --- СБОРКА CHROME ---
      - name: Build Chrome Extension
        run: |
          mkdir -p dist/chrome
          # Копируем всё, кроме служебных файлов git/github и файла переопределений для FF
          rsync -av --progress . dist/chrome --exclude .git --exclude .github --exclude dist --exclude manifest.firefox-overrides.json
          
          # Для Хрома манифест остается без изменений
          
          cd dist/chrome
          zip -r ../extension-chrome.zip .
          cd ../..

      # --- СБОРКА FIREFOX ---
      - name: Build Firefox Extension
        run: |
          mkdir -p dist/firefox
          rsync -av --progress . dist/firefox --exclude .git --exclude .github --exclude dist --exclude manifest.firefox-overrides.json
          
          # Склеиваем основной манифест с настройками для FF
          # '.[0] * .[1]' означает: взять первый файл и наложить на него второй (перезаписать совпадающие поля)
          jq -s '.[0] * .[1]' manifest.json manifest.firefox-overrides.json > dist/firefox/manifest.json
          
          cd dist/firefox
          zip -r ../extension-firefox.zip .
          cd ../..

      # --- СОЗДАНИЕ РЕЛИЗА НА GITHUB ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: "v${{ env.VERSION }} - ${{ env.COMMIT_MSG }}"
          body: |
            Автоматический релиз версии ${{ env.VERSION }}.
            Коммит: ${{ env.COMMIT_MSG }}
          files: |
            dist/extension-chrome.zip
            dist/extension-firefox.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- ПУБЛИКАЦИЯ В CHROME ---
      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v5.0.0
        continue-on-error: true
        with:
          file-path: dist/extension-chrome.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true 

      # --- ПУБЛИКАЦИЯ В FIREFOX ---
      - name: Upload to Firefox Add-ons
        uses: wdzeng/firefox-addon@v1
        continue-on-error: true
        with:
          addon-guid: "{8ab1db50-b280-4711-bd75-68e4bad4aeee}" 
          xpi-path: dist/extension-firefox.zip
          jwt-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
          jwt-secret: ${{ secrets.FIREFOX_JWT_SECRET }}