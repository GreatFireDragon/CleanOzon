name: Build, Release and Publish

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'

# ВАЖНО: Разрешаем скрипту создавать релизы и теги
permissions:
  contents: write

jobs:
  build-release-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Читаем версию из манифеста и заголовок коммита
      - name: Read Version and Commit Message
        id: meta
        run: |
          # Читаем поле version из json
          VERSION=$(jq -r '.version' manifest.chrome.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Берем первую строку сообщения коммита (чтобы заголовок релиза не был огромным)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV
          
          echo "Detected version: $VERSION"
          echo "Commit message: $COMMIT_MSG"

      # --- СБОРКА CHROME ---
      - name: Build Chrome Extension
        run: |
          mkdir -p dist/chrome
          rsync -av --progress . dist/chrome --exclude .git --exclude .github --exclude dist --exclude manifest.firefox.json --exclude manifest.chrome.json
          cp manifest.chrome.json dist/chrome/manifest.json
          cd dist/chrome
          zip -r ../extension-chrome.zip .
          cd ../..

      # --- СБОРКА FIREFOX ---
      - name: Build Firefox Extension
        run: |
          mkdir -p dist/firefox
          rsync -av --progress . dist/firefox --exclude .git --exclude .github --exclude dist --exclude manifest.firefox.json --exclude manifest.chrome.json
          cp manifest.firefox.json dist/firefox/manifest.json
          cd dist/firefox
          zip -r ../extension-firefox.zip .
          cd ../..

      # --- СОЗДАНИЕ РЕЛИЗА НА GITHUB ---
      # Этот шаг создаст тег v<версия> (если его нет) и оформит релиз
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: "v${{ env.VERSION }} - ${{ env.COMMIT_MSG }}"
          body: |
            Автоматический релиз версии ${{ env.VERSION }}.
            Коммит: ${{ env.COMMIT_MSG }}
          files: |
            dist/extension-chrome.zip
            dist/extension-firefox.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- СОХРАНЕНИЕ АРТЕФАКТОВ (На всякий случай оставим) ---
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extensions-v${{ env.VERSION }}
          path: dist/*.zip
          retention-days: 5

      # --- ПУБЛИКАЦИЯ В CHROME ---
      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v5.0.0
        continue-on-error: true
        with:
          file-path: dist/extension-chrome.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true 

      # --- ПУБЛИКАЦИЯ В FIREFOX ---
      - name: Upload to Firefox Add-ons
        uses: wdzeng/firefox-addon@v1
        continue-on-error: true
        with:
          addon-guid: "{8ab1db50-b280-4711-bd75-68e4bad4aeee}" 
          xpi-path: dist/extension-firefox.zip
          jwt-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
          jwt-secret: ${{ secrets.FIREFOX_JWT_SECRET }}